---
- name: Install celery
  gather_facts: No
  hosts: default
  vars:
    - celery_virtualenv_path: ""
    - celery_repo_path: ""
    - celery_user_name: "celery"
    - celery_user_uid: ""
    - celery_user_gid: ""

  tasks:
    - name: Install prerequistite packages
      yum:
        name:
          - git
      become: true
      become_user: root

    - name: Install system Python
      yum:
        name:
          - python3
          - python3-pip
          - python3-setuptools
          - python3-venv
      become: true
      become_user: root

    - name: Ensure virtualenv is using a recent pip version
      pip:
        name: "pip"
        version: ">=20.3"
        virtualenv: {{ celery_virtualenv_path }}
        virtualenv_command: "python3 -m venv"
      become: true
      become_user: root

    - name: Check for requirements file
      stat:
        path: "{{ celery_repo_path }}/requirements.txt"
      register: req_result

    - name: Install package in virtualenv
      pip:
        requirements: "requirements.txt"
        virtualenv: {{ celery_virtualenv_path }}
        virtualenv_command: "python3 -m venv"
      become: true
      become_user: root
      notify: Restart Celery

    - name: Create Celery daemon user / group
      user:
        name: {{ celery_user_name }}
        system: true
        home: {{ celery_virtualenv_path }}
        create_home: false
        shell: /usr/sbin/nologin
      become: true
      become_user: root
      register: user_result

    - name: Set facts about Celery daemon user / group
      set_fact:
        celery_user_uid: {{ celery_user_uid }}
        celery_user_gid: {{ celery_user_gid }}

    - name: Install Celery service
      dest: "/etc/systemd/system/celery.service"
      owner: root
      group: root
      mode: 0644
      become: true
      become_user: root
      notify: Restart Celery

    - name: Enable Celery service
      systemd:
        name: celery
        daemon_reload: true
        enabled: true
      become: true
      become_user: root
